import React, { useState, useEffect, useRef } from "react"; // Đảm bảo import useState, useEffect, useRef từ React
import { supabase } from "./supabaseClient";
import Auth from "./Auth";
import DoctorView from "./DoctorView";
import ReceptionistView from "./ReceptionistView";
import PharmacistView from "./PharmacistView";
import { Session } from "@supabase/supabase-js";
import CharacterModal from "./CharacterModal"; // Import component linh vật

const handleEnterKey = (
  e: React.KeyboardEvent,
  inputs: React.RefObject<
    HTMLInputElement | HTMLTextAreaElement | HTMLButtonElement
  >[]
) => {
  if (e.key === "Enter") {
    const nextInputIndex = inputs.findIndex(
      (input) => input.current === e.target
    );
    if (nextInputIndex >= 0 && nextInputIndex < inputs.length - 1) {
      inputs[nextInputIndex + 1].current?.focus();
    } else {
      inputs[inputs.length - 1].current?.focus();
    }
  }
};

export default function App() {
  const [session, setSession] = useState<Session | null>(null);
  const [role, setRole] = useState<string>("");

  const inputRefs = {
    nameRef: useRef<HTMLInputElement>(null),
    dobRef: useRef<HTMLInputElement>(null),
    weightRef: useRef<HTMLInputElement>(null),
    saveButtonRef: useRef<HTMLButtonElement>(null),
  };

  useEffect(() => {
    const fetchSession = async () => {
      const { data } = await supabase.auth.getSession();
      setSession(data.session);
    };
    fetchSession();

    const { data: listener } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session);
      }
    );
    return () => listener?.subscription.unsubscribe();
  }, []);

  useEffect(() => {
    if (session?.user) {
      supabase
        .from("profiles")
        .select("vai_tro")
        .eq("id", session.user.id)
        .single()
        .then(({ data, error }) => {
          if (error) {
            console.error("Lỗi lấy vai trò:", error.message);
            setRole("");
          } else {
            setRole(data?.vai_tro || "");
          }
        });
    }
  }, [session]);

  if (!session) return <Auth />;
  if (role === "") return <div>Loading role...</div>;

  if (role === "bacsi") return <DoctorView />;

  if (role === "tieptan") {
    return (
      <div>
        <ReceptionistView
          inputRefs={inputRefs}
          handleEnterKey={handleEnterKey}
        />
        <CharacterModal show={true} onClose={() => {}} />
      </div>
    );
  }

  if (role === "duocsi") {
    return (
      <div>
        <PharmacistView />
      </div>
    );
  }

  return <div>Unknown role</div>;
}